# ==========================================
# CONFIGURACIÓN GLOBAL DEL AGENTE
# ==========================================
[agent]
  interval = "5s"             # Frecuencia de recolección por defecto
  round_interval = true
  metric_batch_size = 1000    # Tamaño de lote para enviar a Mimir
  metric_buffer_limit = 10000 # Buffer en RAM si Mimir se cae momentáneamente
  collection_jitter = "0s"
  flush_interval = "5s"
  flush_jitter = "0s"
  precision = ""
  debug = true                # Déjalo en true para ver logs de errores si algo falla
  quiet = false
  hostname = "telegraf-mqtt"

# ==========================================
# INPUT: MQTT CONSUMER
# ==========================================
[[inputs.mqtt_consumer]]
  # Conexión al broker (nombre del servicio en docker-compose)
  servers = ["tcp://mosquitto:1883"]
  
  # Tu tópico definido en el ESP32
  topics = ["sensores/clima"]
  
  # Credenciales (si las tuvieras, si no, déjalas comentadas)
  # username = "tu_usuario"
  # password = "tu_password"

  # --- PROCESAMIENTO DEL JSON ---
  data_format = "json"

  # 1. LA CLAVE DEL ÉXITO: Usar tu timestamp
  # Le dice a Telegraf: "No uses tu reloj, usa el campo 'ts' del JSON"
  json_time_key = "ts"
  json_time_format = "unix"  # Porque envías segundos (time_t), no milisegundos

  # 2. ETIQUETAS (TAGS)
  # 'tipo' (live/hist) se usa para filtrar, no es un valor numérico
  tag_keys = ["tipo"]
  json_string_fields = ["tipo"]

  # 3. RENOMBRADO (Opcional pero recomendado)
  # Esto hará que en Grafana las métricas se llamen:
  # "clima_temp" y "clima_hum" en lugar de "mqtt_consumer_temp"
  name_override = "clima"

# ==========================================
# OUTPUT: GRAFANA MIMIR
# ==========================================
# ==========================================
# OUTPUT: GRAFANA MIMIR
# ==========================================
[[outputs.http]]
  # URL de Mimir (servicio en docker-compose)
  url = "http://mimir:9009/api/v1/push"

  # Formato obligatorio para Mimir/Prometheus
  data_format = "prometheusremotewrite"

  [outputs.http.headers]
    Content-Type = "application/x-protobuf"
    Content-Encoding = "snappy"
    X-Prometheus-Remote-Write-Version = "0.1.0"
    # ID de organización (necesario aunque multitenancy esté false, usa 'demo')
    X-Scope-OrgID = "demo"

# ==========================================
# OUTPUT: DEBUG (Para ver en los logs de Docker qué está pasando)
# ==========================================
[[outputs.file]]
  files = ["stdout"]
  data_format = "influx"